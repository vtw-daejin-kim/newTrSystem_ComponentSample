<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.trsystem.mybatis.mapper.batchMapper">
	<insert id = "executeCostUpdateMM" >
		INSERT INTO MMNY_LBRCO_EXCN (PRJCT_ID, EMP_ID, INPT_YM, MM, GIVE_CT)
			SELECT IND.PRJCT_ID
				  ,IND.EMP_ID 
				  ,IND.APLY_YM
				  ,SUM(MP.MD) / D.COUNT_DAYS AS MM
				  ,SUM(MP.UNTPC * MP.MD)/ D.COUNT_DAYS AS GIVE_CT
			FROM PRJCT_INDVDL_CT_MM IND
			JOIN PRJCT_MM_APLY MP ON (IND.PRJCT_ID=MP.PRJCT_ID AND IND.EMP_ID = MP.EMP_ID AND IND.APLY_YM = MP.APLY_YM AND IND.APLY_ODR = MP.APLY_ODR)
			JOIN PRJCT_MM_ATRZ MT ON (MP.PRJCT_ID=MT.PRJCT_ID AND MP.EMP_ID = MT.EMP_ID AND MP.APLY_YM = MT.APLY_YM AND MP.APLY_ODR = MT.APLY_ODR AND MP.APLY_YMD = MT.APLY_YMD)
			JOIN (SELECT PRJCT_ID, EMP_ID, APLY_YM, MAX(APLY_ODR) AS MAX_ODR
			     	FROM PRJCT_INDVDL_CT_MM
			     	WHERE MM_ATRZ_CMPTN_YN = 'Y'
			     	GROUP BY PRJCT_ID, EMP_ID, APLY_YM
			     ) AS MAX_ODR
				ON (IND.PRJCT_ID = MAX_ODR.PRJCT_ID AND IND.EMP_ID = MAX_ODR.EMP_ID AND IND.APLY_YM = MAX_ODR.APLY_YM)
			LEFT JOIN (SELECT SUBSTRING(CRTR_YMD, 1, 6) AS APLY_YM,
					   		  COUNT(*) AS COUNT_DAYS
					   	 FROM CRTR_DATE cd2 
					   	 WHERE HLDY_CL_CD ='VTW05001'
					   	 GROUP BY SUBSTRING(CRTR_YMD, 1, 6) 
						)AS D
					ON IND.APLY_YM = D.APLY_YM
			WHERE 1=1 
			AND IND.APLY_ODR >= (MAX_ODR.MAX_ODR -2)
			GROUP BY IND.PRJCT_ID, IND.EMP_ID, IND.APLY_YM, D.COUNT_DAYS
		ON DUPLICATE KEY UPDATE MM = VALUES(MM), GIVE_CT = VALUES(GIVE_CT)
	</insert>
	
	<insert id = "executeCostUpdateCT" >
		INSERT INTO EXPENS_EXCN (PRJCT_ID, EXPENS_CD, INPT_YM, EXPENS_CT)
			SELECT IND.PRJCT_ID
				  ,CP.EXPENS_CD
				  ,IND.APLY_YM AS INPT_YM
				  ,SUM(CP.UTZTN_AMT) AS EXPENS_CT
			FROM PRJCT_INDVDL_CT_MM IND
			JOIN PRJCT_CT_APLY CP ON (IND.PRJCT_ID=CP.PRJCT_ID AND IND.EMP_ID = CP.EMP_ID AND IND.APLY_YM = CP.APLY_YM AND IND.APLY_ODR = CP.APLY_ODR)
			JOIN PRJCT_CT_ATRZ CT ON (CP.PRJCT_ID=CT.PRJCT_ID AND CP.EMP_ID = CT.EMP_ID AND CP.APLY_YM = CT.APLY_YM AND CP.APLY_ODR = CT.APLY_ODR AND CP.PRJCT_CT_APLY_SN = CT.PRJCT_CT_APLY_SN)
			JOIN (SELECT PRJCT_ID, EMP_ID, APLY_YM, MAX(APLY_ODR) AS MAX_ODR
			     	FROM PRJCT_INDVDL_CT_MM
			     	WHERE CT_ATRZ_CMPTN_YN = 'Y'
			     	GROUP BY PRJCT_ID, EMP_ID, APLY_YM
			     ) AS MAX_ODR
				ON (IND.PRJCT_ID = MAX_ODR.PRJCT_ID AND IND.EMP_ID = MAX_ODR.EMP_ID AND IND.APLY_YM = MAX_ODR.APLY_YM)
			WHERE 1=1
			AND IND.APLY_ODR >= (MAX_ODR.MAX_ODR -2)
			GROUP BY IND.PRJCT_ID, CP.EXPENS_CD, IND.APLY_YM
		ON DUPLICATE KEY UPDATE EXPENS_CT = VALUES(EXPENS_CT)	
	</insert>
</mapper>